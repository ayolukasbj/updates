RewriteEngine On

# Auto-detect base path (works for root or subdirectory)
# RewriteBase is set dynamically based on installation location

# Skip existing files/directories (must be first)
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Prevent redirect loop - exclude news.php from rewrite
RewriteCond %{REQUEST_URI} ^/news\.php$
RewriteRule ^ - [L]

# Pretty URLs for news details - single rule
# /news/your-slug -> news/index.php?slug=your-slug (which includes news-details.php)
# Must come before the /news rule
RewriteRule ^news/([^/]+)/?$ news/index.php?slug=$1 [L,QSA]

# Serve news listing when accessing /news directly (without slug)
RewriteRule ^news/?$ news.php [L]
# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server information
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Force HTTPS (uncomment when SSL is installed)
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# Protect sensitive files and directories
<FilesMatch "\.(env|log|ini|conf|sql|md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# URL Rewriting for Friendly URLs
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Protect config directory (must come first)
    RewriteRule ^config/ - [F,L]
    RewriteRule ^database/ - [F,L]
    RewriteRule ^logs/ - [F,L]
    
    # Skip rewrite if the requested file or directory exists
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # Song details: song/slug or song/id -> song-details.php
    # If numeric ID, pass as id parameter (will redirect to slug in PHP)
    # If slug (contains letters), pass as slug parameter
    RewriteCond %{REQUEST_URI} ^/song/([0-9]+)$
    RewriteRule ^song/([0-9]+)$ song-details.php?id=$1 [L,QSA]
    RewriteRule ^song/(.+)$ song-details.php?slug=$1 [L,QSA]
    
    # Artist profile: artist/slug -> artist-profile.php?slug=slug
    RewriteRule ^artist/(.+)$ artist-profile.php?slug=$1 [L,QSA]
    
    # Album details: album/slug -> album-details.php?slug=slug
    RewriteRule ^album/(.+)$ album-details.php?slug=$1 [L,QSA]
</IfModule>

# Block access to debug and test files
<FilesMatch "^(debug|backup|working|simple|test|production-cleanup).*\.php$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Prevent directory listing
Options -Indexes

# Protect .htaccess and .htpasswd
<FilesMatch "^\.ht">
    Order allow,deny
    Deny from all
</FilesMatch>

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType audio/mpeg "access plus 1 year"
    ExpiresByType audio/mp3 "access plus 1 year"
</IfModule>

# PHP Settings
<IfModule mod_php7.c>
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>
